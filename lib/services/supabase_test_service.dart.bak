import 'package:flutter/foundation.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../config/supabase_config.dart';

/// Supabaseè¿æ¥æµ‹è¯•æœåŠ¡
/// ç”¨äºéªŒè¯Supabaseè¿æ¥çš„æœ‰æ•ˆæ€§å’ŒåŸºæœ¬åŠŸèƒ½
class SupabaseTestService {
  // Supabaseå®¢æˆ·ç«¯å®ä¾‹
  final SupabaseClient _client = Supabase.instance.client;

  /// æµ‹è¯•Supabaseè¿æ¥æœ‰æ•ˆæ€§
  /// è¿”å›è¿æ¥æµ‹è¯•ç»“æœ
  Future<Map<String, dynamic>> testConnection() async {
    try {
      debugPrint('ğŸ” å¼€å§‹æµ‹è¯•Supabaseè¿æ¥...');
      
      // æµ‹è¯•1: æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦åˆå§‹åŒ–
      if (_client == null) {
        return {
          'success': false,
          'error': 'Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–',
          'details': 'å®¢æˆ·ç«¯å®ä¾‹ä¸ºç©º'
        };
      }

      // æµ‹è¯•2: æ£€æŸ¥URLå’Œå¯†é’¥é…ç½®
      final url = Supabase.instance.client.supabaseUrl;
      final hasAnonKey = Supabase.instance.client.supabaseKey.isNotEmpty;
      
      debugPrint('ğŸ“ Supabase URL: $url');
      debugPrint('ğŸ”‘ åŒ¿åå¯†é’¥å·²é…ç½®: $hasAnonKey');

      // æµ‹è¯•3: å°è¯•ç®€å•çš„æ•°æ®åº“æŸ¥è¯¢ï¼ˆæµ‹è¯•æƒé™ï¼‰
      try {
        // å°è¯•æŸ¥è¯¢ç”¨æˆ·è¡¨ï¼ˆå³ä½¿ä¸ºç©ºä¹Ÿåº”è¯¥èƒ½è¿æ¥ï¼‰
        await _client
            .from(SupabaseTables.users)
            .select('id')
            .limit(1);
        
        debugPrint('âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ');
      } catch (e) {
        debugPrint('âš ï¸ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: $e');
        // è¿™å¯èƒ½æ˜¯æƒé™é—®é¢˜ï¼Œä½†ä¸å½±å“åŸºæœ¬è¿æ¥
      }

      // æµ‹è¯•4: æ£€æŸ¥è®¤è¯çŠ¶æ€
      final currentUser = _client.auth.currentUser;
      debugPrint('ğŸ‘¤ å½“å‰ç”¨æˆ·: ${currentUser?.id ?? 'æœªç™»å½•'}');

      // æµ‹è¯•5: æ£€æŸ¥å­˜å‚¨æ¡¶è®¿é—®æƒé™
      try {
        final buckets = await _client.storage.listBuckets();
        debugPrint('ğŸ“¦ å¯è®¿é—®çš„å­˜å‚¨æ¡¶: ${buckets.length}ä¸ª');
      } catch (e) {
        debugPrint('âš ï¸ å­˜å‚¨æ¡¶è®¿é—®æµ‹è¯•å¤±è´¥: $e');
      }

      return {
        'success': true,
        'url': url,
        'hasAnonKey': hasAnonKey,
        'currentUser': currentUser?.id,
        'message': 'Supabaseè¿æ¥æµ‹è¯•å®Œæˆ'
      };

    } catch (e) {
      debugPrint('âŒ Supabaseè¿æ¥æµ‹è¯•å¤±è´¥: $e');
      return {
        'success': false,
        'error': e.toString(),
        'details': 'è¿æ¥æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸'
      };
    }
  }

  /// æµ‹è¯•æ•°æ®åº“è¡¨è®¿é—®æƒé™
  /// è¿”å›å„è¡¨çš„è®¿é—®çŠ¶æ€
  Future<Map<String, bool>> testTableAccess() async {
    final results = <String, bool>{};
    
    try {
      // æµ‹è¯•ç”¨æˆ·è¡¨
      try {
        await _client.from(SupabaseTables.users).select('id').limit(1);
        results['users'] = true;
      } catch (e) {
        results['users'] = false;
        debugPrint('âŒ ç”¨æˆ·è¡¨è®¿é—®å¤±è´¥: $e');
      }

      // æµ‹è¯•æ•…äº‹è¡¨
      try {
        await _client.from(SupabaseTables.stories).select('id').limit(1);
        results['stories'] = true;
      } catch (e) {
        results['stories'] = false;
        debugPrint('âŒ æ•…äº‹è¡¨è®¿é—®å¤±è´¥: $e');
      }

      // æµ‹è¯•æ ‡ç­¾è¡¨
      try {
        await _client.from(SupabaseTables.tags).select('id').limit(1);
        results['tags'] = true;
      } catch (e) {
        results['tags'] = false;
        debugPrint('âŒ æ ‡ç­¾è¡¨è®¿é—®å¤±è´¥: $e');
      }

      // æµ‹è¯•è¯„è®ºè¡¨
      try {
        await _client.from(SupabaseTables.comments).select('id').limit(1);
        results['comments'] = true;
      } catch (e) {
        results['comments'] = false;
        debugPrint('âŒ è¯„è®ºè¡¨è®¿é—®å¤±è´¥: $e');
      }

      // æµ‹è¯•ç‚¹èµè¡¨
      try {
        await _client.from(SupabaseTables.likes).select('id').limit(1);
        results['likes'] = true;
      } catch (e) {
        results['likes'] = false;
        debugPrint('âŒ ç‚¹èµè¡¨è®¿é—®å¤±è´¥: $e');
      }

      // æµ‹è¯•å…³æ³¨è¡¨
      try {
        await _client.from(SupabaseTables.follows).select('id').limit(1);
        results['follows'] = true;
      } catch (e) {
        results['follows'] = false;
        debugPrint('âŒ å…³æ³¨è¡¨è®¿é—®å¤±è´¥: $e');
      }

    } catch (e) {
      debugPrint('âŒ è¡¨è®¿é—®æµ‹è¯•å¤±è´¥: $e');
    }

    return results;
  }

  /// æµ‹è¯•å­˜å‚¨æ¡¶è®¿é—®æƒé™
  /// è¿”å›å­˜å‚¨æ¡¶è®¿é—®çŠ¶æ€
  Future<Map<String, bool>> testStorageAccess() async {
    final results = <String, bool>{};
    
    try {
      // æµ‹è¯•å¤´åƒå­˜å‚¨æ¡¶
      try {
        await _client.storage.from(SupabaseStorage.avatarsBucket).list();
        results['avatars'] = true;
        debugPrint('âœ… å¤´åƒå­˜å‚¨æ¡¶è®¿é—®æˆåŠŸ');
      } catch (e) {
        results['avatars'] = false;
        debugPrint('âŒ å¤´åƒå­˜å‚¨æ¡¶è®¿é—®å¤±è´¥: $e');
      }

      // æµ‹è¯•æ•…äº‹å›¾ç‰‡å­˜å‚¨æ¡¶
      try {
        await _client.storage.from(SupabaseStorage.storyImagesBucket).list();
        results['story-images'] = true;
        debugPrint('âœ… æ•…äº‹å›¾ç‰‡å­˜å‚¨æ¡¶è®¿é—®æˆåŠŸ');
      } catch (e) {
        results['story-images'] = false;
        debugPrint('âŒ æ•…äº‹å›¾ç‰‡å­˜å‚¨æ¡¶è®¿é—®å¤±è´¥: $e');
      }

    } catch (e) {
      debugPrint('âŒ å­˜å‚¨æ¡¶è®¿é—®æµ‹è¯•å¤±è´¥: $e');
    }

    return results;
  }

  /// æ‰§è¡Œå®Œæ•´çš„SupabaseåŠŸèƒ½æµ‹è¯•
  /// è¿”å›è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Š
  Future<Map<String, dynamic>> runFullTest() async {
    debugPrint('ğŸš€ å¼€å§‹æ‰§è¡Œå®Œæ•´çš„SupabaseåŠŸèƒ½æµ‹è¯•...');
    
    final connectionTest = await testConnection();
    final tableAccessTest = await testTableAccess();
    final storageAccessTest = await testStorageAccess();

    final report = {
      'connection': connectionTest,
      'tableAccess': tableAccessTest,
      'storageAccess': storageAccessTest,
      'timestamp': DateTime.now().toIso8601String(),
    };

    // æ‰“å°æµ‹è¯•æŠ¥å‘Š
    debugPrint('ğŸ“Š Supabaseæµ‹è¯•æŠ¥å‘Š:');
    debugPrint('è¿æ¥çŠ¶æ€: ${connectionTest['success'] ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}');
    debugPrint('è¡¨è®¿é—®çŠ¶æ€: ${tableAccessTest.values.where((v) => v).length}/${tableAccessTest.length} ä¸ªè¡¨å¯è®¿é—®');
    debugPrint('å­˜å‚¨æ¡¶è®¿é—®çŠ¶æ€: ${storageAccessTest.values.where((v) => v).length}/${storageAccessTest.length} ä¸ªå­˜å‚¨æ¡¶å¯è®¿é—®');

    return report;
  }
} 