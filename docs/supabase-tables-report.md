# æ˜Ÿè¶£App Supabase æ•°æ®åº“è¡¨ç»“æ„æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-01-02  
**é¡¹ç›®**: æ˜Ÿè¶£App Webåå°ç®¡ç†ç³»ç»Ÿ  
**æ•°æ®åº“**: Supabase PostgreSQL  

---

## ğŸ“Š æ€»è§ˆ

**é‡å¤§æ›´æ–°**: ç»è¿‡æ­£ç¡®çš„æ•°æ®åº“æŸ¥è¯¢ï¼Œå‘ç°å½“å‰ Supabase é¡¹ç›®ä¸­å…±æœ‰ **12å¼ ** ä»¥ `xq_` å¼€å¤´çš„è¡¨ï¼š

### æœ‰æ•°æ®çš„è¡¨ (5å¼ )
1. âœ… **xq_tracking_events** - è¡Œä¸ºè¿½è¸ªè¡¨ (35è¡Œï¼Œ8ä¸ªå­—æ®µ)
2. âœ… **xq_user_sessions** - ç”¨æˆ·ä¼šè¯è¡¨ (3è¡Œï¼Œ16ä¸ªå­—æ®µ)  
3. âœ… **xq_feedback** - ç”¨æˆ·åé¦ˆè¡¨ (1è¡Œï¼Œ11ä¸ªå­—æ®µ)
4. âœ… **xq_user_profiles** - ç”¨æˆ·é…ç½®è¡¨ (1è¡Œï¼Œ22ä¸ªå­—æ®µ)
5. âœ… **xq_user_settings** - ç”¨æˆ·è®¾ç½®è¡¨ (1è¡Œï¼Œ9ä¸ªå­—æ®µ)

### ç©ºè¡¨ä½†ç»“æ„å®Œæ•´ (7å¼ )
6. ğŸ”¶ **xq_account_deletion_requests** - è´¦æˆ·åˆ é™¤è¯·æ±‚è¡¨ (0è¡Œï¼Œ7ä¸ªå­—æ®µ)
7. ğŸ”¶ **xq_agents** - AIä»£ç†è¡¨ (0è¡Œï¼Œ15ä¸ªå­—æ®µ)
8. ğŸ”¶ **xq_avatars** - å¤´åƒèµ„æºè¡¨ (0è¡Œï¼Œ8ä¸ªå­—æ®µ)
9. ğŸ”¶ **xq_background_music** - èƒŒæ™¯éŸ³ä¹è¡¨ (0è¡Œï¼Œ10ä¸ªå­—æ®µ)
10. ğŸ”¶ **xq_fm_programs** - FMèŠ‚ç›®è¡¨ (0è¡Œï¼Œ11ä¸ªå­—æ®µ)
11. ğŸ”¶ **xq_user_blacklist** - ç”¨æˆ·é»‘åå•è¡¨ (0è¡Œï¼Œ7ä¸ªå­—æ®µ)
12. ğŸ”¶ **xq_voices** - è¯­éŸ³èµ„æºè¡¨ (0è¡Œï¼Œ12ä¸ªå­—æ®µ)

**æŸ¥è¯¢æ–¹å¼**: ä½¿ç”¨ psql ç›´æ¥è¿æ¥æ•°æ®åº“è·å¾—å‡†ç¡®ç»“æœ  
**è¿æ¥å­—ç¬¦ä¸²**: `postgresql://postgres.wqdpqhfqrxvssxifpmvt:PASSWORD@aws-0-ap-southeast-1.pooler.supabase.com:5432/postgres`

---

## ğŸ—„ï¸ è¯¦ç»†è¡¨ç»“æ„

### 1. xq_user_profiles (ç”¨æˆ·é…ç½®è¡¨)

**çŠ¶æ€**: âœ… æ´»è·ƒä½¿ç”¨ä¸­  
**è¡Œæ•°**: 1æ¡è®°å½•  
**å­—æ®µæ•°**: 22ä¸ªå­—æ®µ  

#### å­—æ®µè¯¦æƒ…
```sql
-- ä¸»è¦æ ‡è¯†å­—æ®µ
id                    UUID      -- ä¸»é”®
user_id               UUID      -- å…³è” auth.users è¡¨çš„ç”¨æˆ·ID

-- åŸºæœ¬ä¿¡æ¯å­—æ®µ  
nickname              TEXT      -- ç”¨æˆ·æ˜µç§°
avatar_url            TEXT      -- å¤´åƒURL
bio                   TEXT      -- ä¸ªäººç®€ä»‹
gender                TEXT      -- æ€§åˆ« ('male', 'female', 'other')

-- å¾®ä¿¡é›†æˆå­—æ®µ
wechat_openid         TEXT      -- å¾®ä¿¡OpenID
wechat_unionid        TEXT      -- å¾®ä¿¡UnionID  
wechat_nickname       TEXT      -- å¾®ä¿¡æ˜µç§°
wechat_avatar_url     TEXT      -- å¾®ä¿¡å¤´åƒURL

-- Appleç™»å½•å­—æ®µ
apple_user_id         TEXT      -- Appleç”¨æˆ·ID
apple_email           TEXT      -- Appleé‚®ç®±
apple_full_name       TEXT      -- Appleå…¨å

-- ç»Ÿè®¡å­—æ®µ
likes_received_count  INTEGER   -- æ”¶åˆ°çš„ç‚¹èµæ•°
agents_usage_count    INTEGER   -- AIä»£ç†ä½¿ç”¨æ¬¡æ•°

-- è´¦æˆ·çŠ¶æ€å­—æ®µ
account_status        TEXT      -- è´¦æˆ·çŠ¶æ€ ('active', 'inactive', 'suspended')
deactivated_at        TIMESTAMP -- åœç”¨æ—¶é—´
violation_reason      TEXT      -- è¿è§„åŸå› 

-- ä¼šå‘˜ä¿¡æ¯å­—æ®µ
is_member             BOOLEAN   -- æ˜¯å¦ä¸ºä¼šå‘˜
membership_expires_at TIMESTAMP -- ä¼šå‘˜åˆ°æœŸæ—¶é—´

-- å®¡è®¡å­—æ®µ
created_at            TIMESTAMP -- åˆ›å»ºæ—¶é—´
updated_at            TIMESTAMP -- æœ€åæ›´æ–°æ—¶é—´
```

#### ç¤ºä¾‹æ•°æ®
```json
{
  "id": "18f630cb-e701-45e6-9c34-c26b51040048",
  "user_id": "9978cfbe-5871-4ec2-81ea-21cde3b06276", 
  "nickname": "Gen",
  "avatar_url": "https://wqdpqhfqrxvssxifpmvt.supabase.co/storage/v1/object/...",
  "bio": "",
  "account_status": "active",
  "is_member": false,
  "gender": "male",
  "likes_received_count": 0,
  "agents_usage_count": 0
}
```

### 2. xq_user_sessions (ç”¨æˆ·ä¼šè¯è¡¨)

**çŠ¶æ€**: ğŸ”§ å·²åˆ›å»ºä½†æš‚æ— æ•°æ®  
**è¡Œæ•°**: 0æ¡è®°å½•  
**ç”¨é€”**: è®°å½•ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼Œç”¨äºåˆ†æç”¨æˆ·æ´»è·ƒåº¦å’Œä½¿ç”¨æ—¶é•¿

**æ¨æµ‹å­—æ®µ** (åŸºäºä»£ç ä¸­çš„ä½¿ç”¨):
- `session_duration` - ä¼šè¯æ—¶é•¿
- `created_at` - ä¼šè¯å¼€å§‹æ—¶é—´  
- `user_id` - ç”¨æˆ·ID
- `session_end` - ä¼šè¯ç»“æŸæ—¶é—´

### 3. xq_tracking_events (è¡Œä¸ºè¿½è¸ªè¡¨)

**çŠ¶æ€**: ğŸ”§ å·²åˆ›å»ºä½†æš‚æ— æ•°æ®  
**è¡Œæ•°**: 0æ¡è®°å½•  
**ç”¨é€”**: è®°å½•ç”¨æˆ·è¡Œä¸ºäº‹ä»¶ï¼Œç”¨äºæ•°æ®åˆ†æå’Œç”¨æˆ·è¡Œä¸ºæ´å¯Ÿ

**æ¨æµ‹å­—æ®µ** (åŸºäºä»£ç ä¸­çš„ä½¿ç”¨):
- `user_id` - ç”¨æˆ·ID
- `event_type` - äº‹ä»¶ç±»å‹
- `event_name` - äº‹ä»¶åç§°
- `event_properties` - äº‹ä»¶å±æ€§ (JSON)
- `created_at` - äº‹ä»¶å‘ç”Ÿæ—¶é—´
- `session_id` - ä¼šè¯ID
- `page_name` - é¡µé¢åç§°

### 4. xq_user_settings (ç”¨æˆ·è®¾ç½®è¡¨)

**çŠ¶æ€**: ğŸ”§ å·²åˆ›å»ºä½†æš‚æ— æ•°æ®  
**è¡Œæ•°**: 0æ¡è®°å½•  
**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·ä¸ªäººè®¾ç½®å’Œåå¥½

**æ¨æµ‹ç”¨é€”**:
- é€šçŸ¥è®¾ç½®
- éšç§è®¾ç½®  
- ç•Œé¢åå¥½
- è¯­è¨€è®¾ç½®

### 5. xq_agents (AIä»£ç†è¡¨)

**çŠ¶æ€**: ğŸ”§ å·²åˆ›å»ºä½†æš‚æ— æ•°æ®  
**è¡Œæ•°**: 0æ¡è®°å½•  
**ç”¨é€”**: å­˜å‚¨AIä»£ç†ç›¸å…³ä¿¡æ¯

**æ¨æµ‹ç”¨é€”**:
- AIä»£ç†é…ç½®
- ä»£ç†ä½¿ç”¨è®°å½•
- ä»£ç†æ€§èƒ½æ•°æ®
- ç”¨æˆ·ä¸ä»£ç†çš„äº¤äº’å†å²

---

## ğŸ” é¡¹ç›®ä»£ç ä¸­çš„è¡¨å¼•ç”¨

### å½“å‰ä½¿ç”¨çš„è¡¨
æ ¹æ®ä»£ç åˆ†æï¼Œé¡¹ç›®ä¸»è¦ä½¿ç”¨ä»¥ä¸‹è¡¨ï¼š

1. **xq_user_profiles** - âœ… å¹¿æ³›ä½¿ç”¨
   - ç”¨æˆ·ç®¡ç†é¡µé¢
   - Dashboard ç»Ÿè®¡
   - è®¤è¯ç³»ç»Ÿ

2. **xq_user_sessions** - âœ… éƒ¨åˆ†ä½¿ç”¨  
   - Dashboard ä¼šè¯ç»Ÿè®¡
   - åˆ†æé¡µé¢æ•°æ®æº

3. **xq_tracking_events** - âœ… éƒ¨åˆ†ä½¿ç”¨
   - è¡Œä¸ºåˆ†æ
   - æ´»è·ƒç”¨æˆ·ç»Ÿè®¡

4. **xq_user_settings** - âš ï¸ ä»£ç ä¸­æœªè§æ˜ç¡®ä½¿ç”¨

5. **xq_agents** - âš ï¸ æ–°å‘ç°çš„è¡¨ï¼Œä»£ç ä¸­æš‚æœªä½¿ç”¨

---

## ğŸš¨ å‘ç°çš„é—®é¢˜ä¸å»ºè®®

### 1. æ•°æ®å®Œæ•´æ€§é—®é¢˜
- **é—®é¢˜**: 4å¼ è¡¨ä¸ºç©º (`xq_user_sessions`, `xq_tracking_events`, `xq_user_settings`, `xq_agents`)
- **å½±å“**: Dashboard å’Œåˆ†æé¡µé¢å¯èƒ½æ˜¾ç¤ºä¸å‡†ç¡®çš„ç»Ÿè®¡æ•°æ®
- **å»ºè®®**: æ£€æŸ¥æ•°æ®é‡‡é›†é€»è¾‘ï¼Œç¡®ä¿äº‹ä»¶å’Œä¼šè¯æ•°æ®æ­£å¸¸å†™å…¥

### 2. å­—æ®µå‘½åä¸€è‡´æ€§
- **é—®é¢˜**: ä¹‹å‰ä»£ç ä¸­ä½¿ç”¨äº†ä¸å­˜åœ¨çš„å­—æ®µå
- **è§£å†³**: å·²æ›´æ–°ä»£ç ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
- **å»ºè®®**: ä¸¥æ ¼æŒ‰ç…§å®é™…æ•°æ®åº“ç»“æ„ç¼–å†™æŸ¥è¯¢

### 3. æ–°å‘ç°çš„è¡¨
- **å‘ç°**: `xq_agents` è¡¨å­˜åœ¨ä½†æœªåœ¨ä»£ç ä¸­ä½¿ç”¨
- **å»ºè®®**: ç¡®è®¤è¯¥è¡¨çš„ç”¨é€”ï¼Œæ˜¯å¦éœ€è¦åœ¨å½“å‰é¡¹ç›®ä¸­é›†æˆ

### 4. è¡¨ç»“æ„æ–‡æ¡£åŒ–
- **é—®é¢˜**: ç©ºè¡¨æ— æ³•æ¨æ–­å®Œæ•´ç»“æ„
- **å»ºè®®**: 
  - åœ¨ Supabase æ§åˆ¶å°ä¸­æŸ¥çœ‹å®Œæ•´è¡¨ç»“æ„
  - åˆ›å»ºè¡¨ç»“æ„æ–‡æ¡£
  - æ·»åŠ ç¤ºä¾‹æ•°æ®ç”¨äºæµ‹è¯•

### 5. æ•°æ®åº“èµ„æºä¼˜åŒ–
- **å‘ç°**: é€šè¿‡æš´åŠ›æœç´¢æµ‹è¯•äº†52ä¸ªå¯èƒ½çš„è¡¨åï¼Œä½†å®é™…åªæœ‰5å¼ è¡¨å­˜åœ¨
- **å»ºè®®**: å»ºç«‹å‡†ç¡®çš„æ•°æ®åº“æ–‡æ¡£ï¼Œé¿å…ä¸å¿…è¦çš„æŸ¥è¯¢å’ŒçŒœæµ‹

---

## ğŸ’¡ å¼€å‘å»ºè®®

### 1. æ•°æ®åº“æŸ¥è¯¢æœ€ä½³å®è·µ
```typescript
// âœ… æ­£ç¡®çš„å­—æ®µå¼•ç”¨
const getUserData = async () => {
  const { data, error } = await supabase
    .from('xq_user_profiles')
    .select(`
      id,
      user_id,
      nickname,           // ä¸æ˜¯ username
      account_status,     // ä¸æ˜¯ is_active  
      is_member,          // ä¸æ˜¯ subscription_type
      created_at,
      updated_at          // ä¸æ˜¯ last_sign_in_at
    `)
}
```

### 2. ç±»å‹å®šä¹‰
```typescript
// åŸºäºå®é™…è¡¨ç»“æ„çš„æ¥å£å®šä¹‰
interface XqUserProfile {
  id: string
  user_id: string
  nickname?: string
  avatar_url?: string
  account_status: 'active' | 'inactive' | 'suspended'
  is_member: boolean
  // ... å…¶ä»–å­—æ®µ
}
```

### 3. è°ƒè¯•å·¥å…·
ä½¿ç”¨ `debugTableStructure()` å‡½æ•°æ£€æŸ¥è¡¨ç»“æ„:
```javascript
// æ£€æŸ¥ä»»æ„è¡¨çš„å­—æ®µç»“æ„
debugTableStructure('xq_user_profiles')
```

---

## ğŸ“‹ åç»­è¡ŒåŠ¨é¡¹

### çŸ­æœŸ (1-2å‘¨)
- [ ] æ£€æŸ¥å¹¶ä¿®å¤æ•°æ®é‡‡é›†é€»è¾‘
- [ ] ä¸ºç©ºè¡¨æ·»åŠ ç¤ºä¾‹æ•°æ®
- [ ] å®Œå–„è¡¨ç»“æ„æ–‡æ¡£

### ä¸­æœŸ (1ä¸ªæœˆ)  
- [ ] ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- [ ] å®ç°æ•°æ®å¤‡ä»½ç­–ç•¥
- [ ] æ·»åŠ æ•°æ®ç›‘æ§å‘Šè­¦

### é•¿æœŸ (3ä¸ªæœˆ)
- [ ] è€ƒè™‘æ·»åŠ æ›´å¤šä¸šåŠ¡è¡¨
- [ ] å®ç°æ•°æ®åˆ†ædashboard
- [ ] å»ºç«‹æ•°æ®æ²»ç†è§„èŒƒ

---

## ğŸ“ æ”¯æŒ

å¦‚éœ€äº†è§£æ›´å¤šä¿¡æ¯æˆ–é‡åˆ°é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [é¡¹ç›®ä¸“ç”¨ Supabase æŒ‡å—](./project-supabase-guide.md)
- [Supabase æœ€ä½³å®è·µæ–‡æ¡£](./supabase-best-practices.md)

---

**æŠ¥å‘Šç”Ÿæˆ**: è‡ªåŠ¨åŒ–è„šæœ¬æ£€æµ‹  
**æœ€åæ›´æ–°**: 2025-01-02  
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ